---
- name: install smp
  hosts: smp
  remote_user: ansible
  become: yes
  become_user: root

  tasks:
  - name: create smp user
    register: minecraft_user
    ansible.builtin.user:
      name: minecraft
      create_home: no

  - name: ensure smp base directory
    become: true
    ansible.builtin.file:
      state: directory
      path: /srv/smp

  - name: create minecraft data directory
    become: true
    register: data_dir
    ansible.builtin.file:
      state: directory
      path: "/srv/smp/{{ server_name }}"
      owner: "{{ minecraft_user.name }}"

  - name: write server.properties
    become: true
    ansible.builtin.template:
      dest: "{{ data_dir }}/server.properties"
      src: server.properties.j2
      owner: "{{ minecraft_user.name }}"

  - name: set whitelist
    set_fact:
      whitelist: []

  - name: add to whitelist
    loop: "{{ whitelist_users }}"
    set_fact:
      whitelist: "{{ whitelist + [item] }}"

  - name: write whitelist.json
    become: true
    ansible.builtin.copy:
      dest: "{{ data_dir }}/whitelist.json"
      content: "{{ whitelist }}"
      owner: "{{ minecraft_user.name }}"

  - name: set ops
    set_fact:
      ops: []

  - name: add to ops.json
    loop: "{{ ops }}"
    set_fact:
      ops: "{{ ops + [item] }}"

  - name: write ops.json
    become: true
    ansible.builtin.copy:
      dest: "{{ data_dir }}/ops.json"
      content: "{{ ops }}"

  - name: install docker python package
    become: true
    ansible.builtin.pip:
      name: docker
      state: latest

  - name: start server
    become: true
    community.general.docker_compose:
      project_name: smp
      pull: yes
      definition:
        version: '2.4'
        services:
          server:
            image: itzg/minecraft-server
            environment:
              EULA: 'TRUE'
              TYPE: SPIGOT
              USE_AIKAR_FLAGS: 'true'
              MEMORY: "{{ server_memory }}"
            ports:
              - "25565:25565"
              - "25575:25575"
            volumes:
              - type: bind
                source: "{{ data_dir }}"
                target: /data
            tty: true
            stdin_open: true
            restart: unless-stopped